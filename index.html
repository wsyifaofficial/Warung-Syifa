<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warung Syifa - Sistem Kasir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#16a34a', // Green
                        secondary: '#f97316', // Orange
                        dark: '#1e293b',
                    }
                }
            }
        }
    </script>
    <style>
        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 h-screen flex flex-col" x-data="app()" x-init="initAudio()" x-cloak>

    <!-- Header -->
    <header class="bg-primary text-white shadow-lg sticky top-0 z-20">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white/20 p-2 rounded-lg backdrop-blur-sm">
                    <i class="fa-solid fa-shop text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Warung Syifa</h1>
                    <p class="text-[10px] opacity-90" x-text="currentDate"></p>
                </div>
            </div>
            <button @click="isSettingsModalOpen = true"
                class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center hover:bg-white/30 backdrop-blur-sm transition-colors">
                <i class="fa-solid fa-gear text-xs"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto pb-24 max-w-md mx-auto w-full">

        <!-- TAB 1: STOK (GUDANG) -->
        <div x-show="activeTab === 'stok'" class="p-4 space-y-4">
            <!-- Summary Card -->
            <div
                class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center group hover:border-blue-300 transition-colors">
                <div>
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Total Aset Barang</h3>
                    <p class="text-xl font-bold text-gray-800" x-text="formatRupiah(totalAsset)"></p>
                </div>
                <div class="bg-blue-50 p-3 rounded-xl text-blue-600 group-hover:bg-blue-100 transition-colors">
                    <i class="fa-solid fa-boxes-stacked text-xl"></i>
                </div>
            </div>

            <!-- HELP GUIDE BOX -->
            <div x-data="{ showHelp: true }" x-show="showHelp"
                class="mb-4 bg-white p-4 rounded-xl border border-blue-100 shadow-sm relative">
                <button @click="showHelp = false" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times"></i>
                </button>
                <h4 class="font-bold text-blue-800 text-xs mb-2 flex items-center gap-2">
                    <i class="fa-solid fa-circle-info"></i> PETUNJUK GUDANG
                </h4>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="flex items-start gap-2">
                        <div
                            class="w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center shrink-0 text-[10px] shadow-sm">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                        <div>
                            <span class="font-bold text-gray-700">Barang Baru</span>
                            <p class="text-gray-500 leading-tight">Untuk barang yang belum pernah dijual.</p>
                        </div>
                    </div>
                    <div class="flex items-start gap-2">
                        <div
                            class="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center shrink-0 text-[10px]">
                            <i class="fa-solid fa-boxes-stacked"></i>
                        </div>
                        <div>
                            <span class="font-bold text-gray-700">Kulakan</span>
                            <p class="text-gray-500 leading-tight">Untuk tambah stok barang lama.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search & Filter -->
            <div class="sticky top-0 bg-gray-100 pt-2 pb-2 z-10">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
                    <input type="text" x-model="searchQuery" placeholder="Cari Nama Barang..."
                        class="w-full pl-11 pr-4 py-3 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-primary outline-none text-sm">
                </div>
            </div>

            <!-- Item List (Table Style) -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-3">Barang</th>
                            <th class="px-4 py-3 text-right">Stok</th>
                            <th class="px-4 py-3 text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <template x-for="item in filteredItems" :key="item.id">
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3">
                                    <div class="font-bold text-gray-800" x-text="item.name"></div>
                                    <div class="text-[10px] text-gray-500 mt-0.5">
                                        Beli: <span x-text="formatRupiah(item.buyPrice)"></span> |
                                        Jual: <span class="text-primary font-bold"
                                            x-text="formatRupiah(item.sellPrice)"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 text-right">
                                    <span class="inline-block px-2.5 py-1 rounded-md font-bold text-xs"
                                        :class="item.stock < 3 ? 'bg-red-100 text-red-600 animate-pulse' : 'bg-gray-100 text-gray-700'"
                                        x-text="item.stock"></span>
                                </td>
                                <td class="px-4 py-3 text-center flex justify-center gap-2">
                                    <button @click="openStockModal(item)"
                                        class="text-green-600 hover:text-green-800 w-8 h-8 rounded-full hover:bg-green-50 transition-colors tooltip"
                                        title="Kulakan (Tambah Stok Lama)">
                                        <i class="fa-solid fa-boxes-stacked text-lg"></i>
                                    </button>
                                    <button @click="editItem(item)"
                                        class="text-gray-400 hover:text-blue-600 w-8 h-8 rounded-full hover:bg-blue-50 transition-colors tooltip"
                                        title="Edit Detail">
                                        <i class="fa-solid fa-pen-to-square"></i>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="filteredItems.length === 0">
                            <td colspan="3" class="p-8 text-center text-gray-400 text-sm">
                                <i class="fa-solid fa-box-open text-2xl mb-2 opacity-30"></i>
                                <p>Tidak ada barang ditemukan.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- FAB Add Button -->
            <button @click="openModal('add')"
                class="fixed bottom-24 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center hover:bg-blue-700 transition active:scale-90 z-20">
                <i class="fa-solid fa-plus text-xl"></i>
            </button>
        </div>


        <!-- TAB 2: KASIR (TRANSAKSI) -->
        <div x-show="activeTab === 'kasir'" class="p-4 space-y-4">

            <div class="text-center mb-4">
                <h2 class="text-lg font-bold text-gray-700">ðŸ›’ Kasir Penjualan</h2>
                <p class="text-xs text-gray-500">Pilih barang untuk mencatat penjualan</p>
            </div>

            <!-- Search -->
            <div class="relative">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-400"></i>
                <input type="text" x-model="searchQuery" placeholder="Cari barang untuk dijual..."
                    class="w-full pl-11 pr-4 py-3 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-secondary outline-none text-sm">
            </div>

            <!-- Grid Items -->
            <div class="grid grid-cols-2 gap-3">
                <template x-for="item in filteredItems" :key="item.id">
                    <button @click="openSellModal(item)"
                        class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 text-left hover:border-secondary transition active:scale-95 group relative overflow-hidden flex flex-col justify-between min-h-[100px]"
                        :disabled="item.stock <= 0">

                        <div x-show="item.stock <= 0"
                            class="absolute inset-0 bg-gray-50/90 flex items-center justify-center z-10 backdrop-blur-[1px]">
                            <span
                                class="text-[10px] font-bold text-red-500 border border-red-200 bg-red-50 px-2 py-1 rounded-full uppercase tracking-wider">Stok
                                Habis</span>
                        </div>

                        <h4 class="font-bold text-gray-700 mb-1 leading-snug line-clamp-2 text-sm" x-text="item.name">
                        </h4>

                        <div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-end w-full">
                            <span class="text-secondary font-bold text-sm" x-text="formatRupiah(item.sellPrice)"></span>
                            <span class="text-[10px] bg-gray-100 px-1.5 py-0.5 rounded text-gray-500 font-medium">Sisa:
                                <span x-text="item.stock"></span></span>
                        </div>
                    </button>
                </template>
            </div>
        </div>

        <!-- HUTANG VIEW -->
        <div x-show="activeTab === 'hutang'" class="space-y-4">
            <!-- Header Summary -->
            <div class="bg-red-600 text-white p-4 rounded-xl shadow-lg">
                <div class="text-xs opacity-80 mb-1">Total Belum Dibayar</div>
                <div class="text-2xl font-bold font-mono tracking-tight"
                    x-text="formatRupiah(debts.reduce((sum, d) => sum + d.total, 0))"></div>
                <div class="text-xs mt-2 bg-red-700/50 inline-block px-2 py-0.5 rounded">
                    <span x-text="debts.length"></span> Transaksi Menggantung
                </div>
            </div>

            <!-- Debt List -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div x-show="debts.length === 0" class="p-8 text-center text-gray-400">
                    <i class="fa-solid fa-thumbs-up text-4xl mb-2 text-gray-200"></i>
                    <p class="text-sm">Tidak ada yang ngutang!</p>
                </div>

                <template x-for="debt in debts.slice().reverse()" :key="debt.id">
                    <div class="p-4 border-b border-gray-50 hover:bg-gray-50 transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="font-bold text-gray-800" x-text="debt.customerName"></div>
                                <div class="text-xs text-gray-500">
                                    <span x-text="formatDateShort(debt.timestamp)"></span> â€¢
                                    <span x-text="debt.itemName"></span> (<span x-text="debt.qty"></span>)
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-red-600" x-text="formatRupiah(debt.total)"></div>
                                <div class="text-[10px] text-red-400 italic">Belum Lunas</div>
                            </div>
                        </div>
                        <button @click="payDebt(debt.id)"
                            class="w-full py-2 bg-green-100 text-green-700 rounded-lg text-xs font-bold hover:bg-green-200 transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-money-bill-wave"></i> LUNASI SEKARANG
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- TAB 3: LAPORAN -->
        <div x-show="activeTab === 'laporan'" class="p-4 space-y-6">

            <!-- Date Filter -->
            <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
                <span class="text-xs font-bold text-gray-500 uppercase">Periode:</span>
                <input type="month" x-model="dateFilter"
                    class="text-sm font-bold text-gray-800 outline-none bg-transparent text-right">
            </div>

            <!-- Daily Stats -->
            <div class="grid grid-cols-3 gap-2">
                <!-- Omzet (Money In) -->
                <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between">
                    <p class="text-[9px] text-gray-500 uppercase tracking-wider font-semibold mb-1">Pemasukan (Omzet)
                    </p>
                    <h3 class="font-bold text-sm text-gray-800" x-text="formatRupiah(filteredRevenue)"></h3>
                </div>

                <!-- Belanja (Money Out) -->
                <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between">
                    <p class="text-[9px] text-gray-500 uppercase tracking-wider font-semibold mb-1">Pengeluaran
                        (Belanja)</p>
                    <h3 class="font-bold text-sm text-red-600" x-text="formatRupiah(filteredExpense)"></h3>
                </div>

                <!-- Profit (Laba) -->
                <div
                    class="bg-gradient-to-br from-green-500 to-emerald-600 p-3 rounded-xl text-white shadow-lg flex flex-col justify-between">
                    <p class="text-[9px] text-green-100 uppercase tracking-wider font-semibold mb-1">Profit (Laba)</p>
                    <h3 class="font-bold text-sm" x-text="formatRupiah(filteredProfit)"></h3>
                </div>
            </div>

            <!-- ANALYTICS WIDGETS -->
            <div class="grid grid-cols-2 gap-3">
                <!-- Best Sellers -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3">
                    <h3 class="font-bold text-gray-800 text-[10px] uppercase mb-2 flex items-center gap-1.5">
                        <i class="fa-solid fa-fire text-orange-500"></i> Paling Laris
                    </h3>
                    <div class="space-y-2">
                        <template x-for="(item, index) in bestSellers.slice(0, 3)" :key="index">
                            <div class="flex justify-between items-center text-xs">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span
                                        class="w-4 h-4 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-[9px] font-bold flex-shrink-0"
                                        x-text="index + 1"></span>
                                    <span class="text-gray-700 font-medium truncate" x-text="item.name"></span>
                                </div>
                                <span class="font-bold text-gray-900 flex-shrink-0"><span x-text="item.qty"></span>
                                    <span class="text-[9px] text-gray-400 font-normal">top</span></span>
                            </div>
                        </template>
                        <div x-show="bestSellers.length === 0" class="text-center text-[10px] text-gray-400 py-2">Belum
                            ada data.</div>
                    </div>
                </div>

                <!-- Worst Sellers (Dead Stock) -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3">
                    <h3 class="font-bold text-gray-800 text-[10px] uppercase mb-2 flex items-center gap-1.5">
                        <i class="fa-solid fa-snowflake text-blue-500"></i> Kurang Laku
                    </h3>
                    <div class="space-y-2">
                        <template x-for="(item, index) in worstSellers" :key="index">
                            <div class="flex justify-between items-center text-xs">
                                <div class="flex items-center gap-2 overflow-hidden">
                                    <span
                                        class="w-4 h-4 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[9px] font-bold flex-shrink-0"
                                        x-text="index + 1"></span>
                                    <span class="text-gray-700 font-medium truncate" x-text="item.name"></span>
                                </div>
                                <span class="font-bold text-gray-500 flex-shrink-0"><span x-text="item.sales"></span>
                                    <span class="text-[9px] text-gray-400 font-normal">jual</span></span>
                            </div>
                        </template>
                        <div x-show="worstSellers.length === 0" class="text-center text-[10px] text-gray-400 py-2">Stok
                            aman.</div>
                    </div>
                </div>
            </div>

            <!-- Transaction Table -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-4 py-3 border-b bg-gray-50 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 text-sm"><i class="fa-solid fa-list-check mr-2"></i>Rincian
                        Penjualan</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 whitespace-nowrap">Waktu</th>
                                <th class="px-4 py-3 whitespace-nowrap">Barang</th>
                                <th class="px-4 py-3 text-right whitespace-nowrap">Info</th>
                                <th class="px-4 py-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="log in salesLogs.slice(0, 15)" :key="log.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-3 text-xs whitespace-nowrap">
                                        <div x-text="formatTime(log.timestamp)"></div>
                                        <div class="text-[10px] text-gray-400" x-text="formatDateShort(log.timestamp)">
                                        </div>
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="font-medium text-gray-800 line-clamp-1" x-text="log.itemName"></div>
                                        <div class="text-[10px] text-gray-400"><span x-text="log.qty"></span> x <span
                                                x-text="formatRupiah(log.price)"></span></div>
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <div class="font-bold text-gray-700 text-xs"
                                            x-text="formatRupiah(log.qty * log.price)"></div>
                                        <div class="text-[10px] text-green-600 font-medium">Untung: <span
                                                x-text="formatRupiah((log.price - log.buyPrice) * log.qty)"></span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 text-center flex justify-center gap-2">
                                        <button @click="openReceipt(log)"
                                            class="text-gray-500 hover:text-gray-700 w-8 h-8 rounded-full hover:bg-gray-100 flex items-center justify-center transition-colors tooltip"
                                            title="Lihat Struk">
                                            <i class="fa-solid fa-receipt text-lg"></i>
                                        </button>
                                        <button @click="sendWhatsApp(log)"
                                            class="text-green-500 hover:text-green-700 w-8 h-8 rounded-full hover:bg-green-50 flex items-center justify-center transition-colors tooltip"
                                            title="Kirim WA">
                                            <i class="fa-brands fa-whatsapp text-lg"></i>
                                        </button>
                                        <button @click="deleteLog(log)"
                                            class="text-red-400 hover:text-red-600 w-8 h-8 rounded-full hover:bg-red-50 flex items-center justify-center transition-colors tooltip"
                                            title="Hapus / Undo">
                                            <i class="fa-solid fa-trash text-sm"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="salesLogs.length === 0">
                                <td colspan="4" class="p-8 text-center text-gray-400 text-xs">
                                    Belum ada data penjualan.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer / Branding (Fixed/Sticky at bottom of content) -->
    <div class="bg-gray-100 pb-2 text-center opacity-70 hover:opacity-100 transition-opacity duration-300">
        <div class="flex items-center justify-center gap-1.5 mb-0.5">
            <img src="logo_zensheet.png" alt="ZenSheet" class="w-4 h-4 object-contain opacity-70">
            <span class="text-[10px] font-bold text-gray-400 font-mono tracking-wider">POWERED BY ZENSHEET</span>
        </div>
        <a href="https://zensheet.my.id" target="_blank"
            class="text-[9px] text-gray-400 hover:text-blue-500 transition-colors">zensheet.my.id</a>
    </div>

    <!-- Bottom Navigation -->
    <nav
        class="bg-white border-t border-gray-200 flex justify-around items-center h-20 pb-2 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] sticky bottom-0 z-30 max-w-md mx-auto w-full text-gray-400 font-medium text-[10px]">

        <button @click="activeTab = 'stok'; searchQuery = ''"
            class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative"
            :class="activeTab === 'stok' ? 'text-blue-600' : 'hover:text-gray-600'">
            <div class="text-xl mb-0.5"><i class="fa-solid fa-box"></i></div>
            <span>STOK</span>
            <div x-show="activeTab === 'stok'" class="absolute top-0 w-12 h-1 bg-blue-600 rounded-b-full"></div>
        </button>

        <button @click="activeTab = 'kasir'; searchQuery = ''"
            class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative"
            :class="activeTab === 'kasir' ? 'text-secondary' : 'hover:text-gray-600'">
            <div class="text-2xl mb-0.5 transform -translate-y-1"><i class="fa-solid fa-cash-register"></i></div>
            <span class="text-xs font-bold">KASIR</span>
            <div x-show="activeTab === 'kasir'" class="absolute top-0 w-12 h-1 bg-secondary rounded-b-full"></div>
        </button>

        <button @click="activeTab = 'hutang'"
            class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative"
            :class="activeTab === 'hutang' ? 'text-red-600' : 'hover:text-gray-600'">
            <div class="text-xl mb-0.5 relative">
                <i class="fa-solid fa-book-open"></i>
                <span x-show="debts.length > 0"
                    class="absolute -top-1 -right-2 w-2.5 h-2.5 bg-red-600 rounded-full border-2 border-white"></span>
            </div>
            <span>HUTANG</span>
            <div x-show="activeTab === 'hutang'" class="absolute top-0 w-12 h-1 bg-red-600 rounded-b-full"></div>
        </button>

        <button @click="activeTab = 'laporan'; searchQuery = ''"
            class="flex flex-col items-center justify-center w-full h-full space-y-1 transition-colors relative"
            :class="activeTab === 'laporan' ? 'text-primary' : 'hover:text-gray-600'">
            <div class="text-xl mb-0.5"><i class="fa-solid fa-chart-pie"></i></div>
            <span>LAPORAN</span>
            <div x-show="activeTab === 'laporan'" class="absolute top-0 w-12 h-1 bg-primary rounded-b-full"></div>
        </button>

    </nav>


    <!-- MODALS -->

    <!-- Add/Edit Item Modal -->
    <div x-show="isModalOpen"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        style="display: none;" x-transition.opacity>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all"
            @click.away="closeModal()" x-transition.scale>
            <h2 class="text-xl font-bold mb-4" x-text="editMode ? 'Edit Barang' : 'Tambah Stok Baru'"></h2>

            <div class="space-y-4">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Barcode / Kode Barang</label>
                    <div class="flex gap-2">
                        <input type="text" x-model="tempItem.barcode"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                            placeholder="Scan atau ketik manual...">
                        <button @click="startScanner('input')"
                            class="bg-gray-800 text-white px-3 rounded shadow hover:bg-black transition-colors">
                            <i class="fa-solid fa-qrcode"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Nama Barang</label>
                    <input type="text" x-model="tempItem.name"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Harga Beli (Kulak)</label>
                        <input type="number" x-model.number="tempItem.buyPrice"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1">Harga Jual</label>
                        <input type="number" x-model.number="tempItem.sellPrice"
                            class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Stok Saat Ini (Adjustment)</label>
                    <input type="number" x-model.number="tempItem.stock" :disabled="editMode"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none font-bold disabled:bg-gray-100 disabled:text-gray-400">
                    <p x-show="editMode" class="text-[10px] text-red-500 mt-1 leading-tight">
                        <i class="fa-solid fa-lock mr-1"></i> Stok dikunci. Gunakan tombol <strong>Kardus
                            (Kulakan)</strong> di tabel untuk tambah stok agar tercatat di laporan.
                    </p>
                </div>
            </div>

            <div class="mt-6 flex gap-2">
                <button @click="closeModal()"
                    class="flex-1 px-4 py-3 bg-gray-100 rounded-xl text-gray-600 font-bold text-sm hover:bg-gray-200 transaction-colors">Batal</button>
                <button @click="saveItem()"
                    class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-bold text-sm hover:bg-blue-700 shadow-lg shadow-blue-200 transaction-colors">Simpan</button>
            </div>
            <div x-show="editMode" class="mt-4 text-center">
                <button @click="deleteItem()" class="text-red-400 text-xs hover:text-red-600 hover:underline">Hapus
                    Permanen</button>
            </div>
        </div>
    </div>

    <!-- Stock Log Modal (For Adding Stock) -->
    <div x-show="isStockModalOpen"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        style="display: none;" x-transition.opacity>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all"
            @click.away="isStockModalOpen=false" x-transition.scale>
            <div class="text-center mb-4">
                <div
                    class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-2 text-xl">
                    <i class="fa-solid fa-boxes-stacked"></i>
                </div>
                <h2 class="text-lg font-bold text-gray-800">Barang Masuk (Kulakan)</h2>
                <p class="text-sm text-gray-500 font-medium" x-text="stockForm.itemName"></p>
            </div>

            <div class="space-y-4">
                <!-- Quantity Input -->
                <div class="flex items-center justify-center gap-4">
                    <button @click="stockForm.qty = Math.max(1, stockForm.qty - 1)"
                        class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200"><i
                            class="fa-solid fa-minus"></i></button>
                    <div class="text-center w-24">
                        <label class="block text-[10px] text-gray-400 mb-1">Jumlah Masuk</label>
                        <input type="number" x-model.number="stockForm.qty"
                            class="w-full text-center text-3xl font-bold outline-none border-b-2 border-green-500 py-1 bg-transparent">
                    </div>
                    <button @click="stockForm.qty = stockForm.qty + 1"
                        class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 font-bold hover:bg-gray-200"><i
                            class="fa-solid fa-plus"></i></button>
                </div>

                <!-- Price Inputs (Optional Update) -->
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                    <p class="text-[10px] text-gray-500 mb-2 font-bold uppercase tracking-wide">Update Harga (Opsional)
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">Harga Beli Baru</label>
                            <input type="number" x-model.number="stockForm.buyPrice"
                                class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs focus:border-green-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">Harga Jual Baru</label>
                            <input type="number" x-model.number="stockForm.sellPrice"
                                class="w-full border border-gray-300 rounded-lg px-2 py-1.5 text-xs focus:border-green-500 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <button @click="saveStock()"
                class="w-full mt-6 py-3 rounded-xl font-bold text-white shadow-lg bg-green-600 hover:bg-green-700 active:scale-95 transition-all">
                <i class="fa-solid fa-check mr-2"></i> SIMPAN STOK
            </button>
            <button @click="isStockModalOpen=false"
                class="w-full mt-2 py-2 text-gray-400 hover:text-gray-600 text-xs font-bold">
                Batal
            </button>
        </div>
    </div>

    <!-- Sell Modal (Kasir) -->
    <div x-show="isSellModalOpen"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        style="display: none;" x-transition.opacity>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all"
            @click.away="closeSellModal()" x-transition.scale>
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-gray-800" x-text="sellForm.itemName"></h2>
                <p class="text-secondary font-bold text-lg" x-text="formatRupiah(sellForm.price)"></p>
                <p class="text-xs text-gray-400 mt-1">Stok Tersedia: <span x-text="sellForm.maxStock"></span></p>
            </div>

            <div class="flex items-center justify-center gap-6 mb-8">
                <button @click="sellForm.qty = Math.max(1, sellForm.qty - 1)"
                    class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 font-bold text-xl hover:bg-gray-200 transition-colors"><i
                        class="fa-solid fa-minus"></i></button>
                <div class="text-center">
                    <input type="number" x-model.number="sellForm.qty"
                        class="w-24 text-center text-4xl font-bold outline-none border-b-2 border-secondary py-1 text-gray-800 bg-transparent">
                    <p class="text-[10px] text-gray-400 mt-1">Jumlah Beli</p>
                </div>
                <button @click="sellForm.qty = Math.min(sellForm.maxStock, sellForm.qty + 1)"
                    class="w-12 h-12 rounded-full bg-gray-100 text-gray-600 font-bold text-xl hover:bg-gray-200 transition-colors"><i
                        class="fa-solid fa-plus"></i></button>
            </div>

            <!-- Debt Option (Kasbon) -->
            <div class="mb-4 bg-red-50 p-3 rounded-lg border border-red-100">
                <label class="flex items-center gap-2 cursor-pointer mb-2">
                    <input type="checkbox" x-model="sellForm.isDebt"
                        class="w-4 h-4 text-red-600 rounded focus:ring-red-500">
                    <span class="text-sm font-bold text-red-700">Bayar Nanti (Kasbon/Hutang)</span>
                </label>
                <div x-show="sellForm.isDebt" x-transition>
                    <label class="block text-xs text-red-600 mb-1">Nama Peminjam</label>
                    <input type="text" x-model="sellForm.customerName"
                        class="shadow appearance-none border border-red-200 rounded w-full py-2 px-3 text-gray-700 text-sm leading-tight focus:outline-none focus:ring-1 focus:ring-red-500"
                        placeholder="Contoh: Pak Budi">
                </div>
            </div>

            <div class="bg-orange-50 p-3 rounded-xl mb-6 flex justify-between items-center border border-orange-100">
                <span class="text-xs text-orange-600 font-bold uppercase">Total Bayar</span>
                <span class="font-bold text-xl text-orange-700"
                    x-text="formatRupiah(sellForm.price * sellForm.qty)"></span>
            </div>

            <button @click="confirmSale()"
                class="w-full py-4 rounded-xl font-bold text-white shadow-lg bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 active:scale-95 transition-all">
                <i class="fa-solid fa-check mr-2"></i> TERIMA UANG
            </button>
        </div>
    </div>

    <!-- Scanner Modal -->
    <div x-show="isScannerOpen" class="fixed inset-0 bg-black/90 z-[60] flex flex-col items-center justify-center p-4"
        style="display: none;" x-transition.opacity>

        <div class="w-full max-w-sm bg-white rounded-2xl overflow-hidden relative">
            <button @click="stopScanner()"
                class="absolute top-4 right-4 z-10 bg-white/20 text-white rounded-full p-2 backdrop-blur-md">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>

            <div class="p-4 bg-gray-900 text-white text-center">
                <h3 class="font-bold text-lg"
                    x-text="scanMode === 'input' ? 'Scan Barcode Barang' : 'Scan untuk Kasir'"></h3>
                <p class="text-xs opacity-70">Arahkan kamera ke kode batang produk</p>
            </div>

            <div id="reader" class="w-full bg-black min-h-[300px]"></div>

            <div class="p-4 bg-white text-center">
                <p class="text-sm text-gray-500 animate-pulse">Mencari kamera...</p>
            </div>
        </div>
    </div>

    <!-- Receipt Modal (Struk) -->
    <div x-show="isReceiptModalOpen"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        style="display: none;" x-transition.opacity>

        <div class="w-full max-w-sm flex flex-col max-h-[90vh]">

            <!-- Receipt Preview Area (To be captured) -->
            <div id="receipt-preview" class="bg-white p-6 rounded-t-2xl shadow-2xl relative overflow-hidden">
                <!-- Decorative jagged top -->
                <div class="absolute top-0 left-0 right-0 h-4 bg-gray-800"
                    style="clip-path: polygon(0% 0%, 5% 100%, 10% 0%, 15% 100%, 20% 0%, 25% 100%, 30% 0%, 35% 100%, 40% 0%, 45% 100%, 50% 0%, 55% 100%, 60% 0%, 65% 100%, 70% 0%, 75% 100%, 80% 0%, 85% 100%, 90% 0%, 95% 100%, 100% 0%);">
                </div>

                <div class="text-center mt-4 mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 tracking-wider">WARUNG SYIFA</h2>
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">Struk Pembelian Resmi</p>
                </div>

                <div class="space-y-4 font-mono text-sm">
                    <div class="flex justify-between text-xs text-gray-500 border-b border-dashed border-gray-300 pb-2">
                        <span x-text="formatDateShort(receiptData.timestamp)"></span>
                        <span x-text="formatTime(receiptData.timestamp)"></span>
                    </div>

                    <div class="py-2">
                        <div class="flex justify-between items-start font-bold text-gray-800 text-lg">
                            <span x-text="receiptData.itemName"></span>
                        </div>
                        <div class="flex justify-between items-center text-gray-600 mt-1">
                            <span><span x-text="receiptData.qty"></span> x <span
                                    x-text="formatRupiah(receiptData.price)"></span></span>
                            <span class="font-bold text-gray-800"
                                x-text="formatRupiah(receiptData.qty * receiptData.price)"></span>
                        </div>
                    </div>

                    <div class="border-t border-dashed border-gray-300 pt-4 pb-2">
                        <div class="flex justify-between items-center text-xl font-bold">
                            <span>TOTAL</span>
                            <span x-text="formatRupiah(receiptData.qty * receiptData.price)"></span>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8 pt-4 border-t border-gray-100">
                    <p class="text-xs text-gray-400 font-medium italic">"Terima Kasih Sudah Berbelanja"</p>
                    <div class="flex items-center justify-center gap-1 mt-2 opacity-50">
                        <img src="logo_zensheet.png" class="w-3 h-3 grayscale">
                        <span class="text-[8px] font-bold text-gray-400">POWERED BY ZENSHEET</span>
                    </div>
                </div>

                <!-- Decorative jagged bottom -->
                <div class="absolute bottom-0 left-0 right-0 h-4 bg-white"
                    style="clip-path: polygon(0% 100%, 5% 0%, 10% 100%, 15% 0%, 20% 100%, 25% 0%, 30% 100%, 35% 0%, 40% 100%, 45% 0%, 50% 100%, 55% 0%, 60% 100%, 65% 0%, 70% 100%, 75% 0%, 80% 100%, 85% 0%, 90% 100%, 95% 0%, 100% 100%);">
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-gray-100 p-4 rounded-b-2xl border-t border-gray-200 space-y-2">
                <button @click="downloadReceipt()"
                    class="w-full py-3 bg-gray-800 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-black transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-camera"></i> Simpan Gambar
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button @click="emailReceipt()"
                        class="py-2.5 bg-white text-gray-700 border border-gray-300 rounded-xl font-bold text-xs hover:bg-gray-50 transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-envelope"></i> Email
                    </button>
                    <button @click="isReceiptModalOpen = false"
                        class="py-2.5 bg-transparent text-gray-500 rounded-xl font-bold text-xs hover:text-gray-700 transition-colors">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings & Backup Modal -->
    <div x-show="isSettingsModalOpen"
        class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
        style="display: none;" x-transition.opacity>
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform transition-all"
            @click.away="isSettingsModalOpen = false" x-transition.scale>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">Pengaturan</h2>
                <button @click="isSettingsModalOpen = false" class="text-gray-400 hover:text-gray-600"><i
                        class="fa-solid fa-times"></i></button>
            </div>

            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h3 class="font-bold text-blue-800 text-sm mb-1"><i class="fa-solid fa-floppy-disk mr-2"></i>Amankan
                        Data</h3>
                    <p class="text-xs text-blue-600 mb-3">Download data secara berkala agar tidak hilang saat ganti HP.
                    </p>
                    <button @click="downloadBackup()"
                        class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-bold shadow-sm transition-colors">
                        Download Backup (.json)
                    </button>
                </div>

                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h3 class="font-bold text-gray-700 text-sm mb-1"><i class="fa-solid fa-file-import mr-2"></i>Restore
                        Data</h3>
                    <p class="text-xs text-gray-500 mb-3">Kembalikan data dari file backup yang sudah didownload.</p>
                    <input type="file" x-ref="fileInput" @change="restoreBackup($event)" class="hidden">
                    <button @click="$refs.fileInput.click()"
                        class="w-full py-2 bg-white border border-gray-300 hover:bg-gray-100 text-gray-700 rounded-lg text-xs font-bold transition-colors">
                        Pilih File Backup
                    </button>
                </div>

                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <h3 class="font-bold text-green-800 text-sm mb-1"><i
                            class="fa-brands fa-google-drive mr-2"></i>Google Sheets Sync</h3>
                    <p class="text-xs text-green-700 mb-2">Simpan data ke Google Sheets secara Online.</p>
                    <input type="text" x-model="googleScriptUrl" placeholder="Tempel URL Google Apps Script disini..."
                        class="w-full border border-green-200 rounded px-2 py-1.5 text-xs mb-2 focus:ring-1 focus:ring-green-500 outline-none">
                    <div class="flex gap-2">
                        <button @click="syncToGoogle()"
                            class="flex-1 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg text-xs font-bold shadow-sm transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-cloud-arrow-up text-sm"></i>
                            <span>BACKUP</span>
                            <span class="text-[9px] font-normal opacity-80">(HP &rarr; Cloud)</span>
                        </button>
                        <button @click="pullFromGoogle()"
                            class="flex-1 py-2.5 bg-white border border-green-600 text-green-600 hover:bg-green-50 rounded-lg text-xs font-bold shadow-sm transition-colors flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-cloud-arrow-down text-sm"></i>
                            <span>RESTORE</span>
                            <span class="text-[9px] font-normal opacity-80">(Cloud &rarr; HP)</span>
                        </button>
                    </div>
                    <div class="flex justify-between px-1 mt-2">
                        <p class="text-[9px] text-gray-400 text-center w-1/2 pr-1">Simpan data HP ini ke internet (Timpa
                            Google Data).</p>
                        <p class="text-[9px] text-gray-400 text-center w-1/2 pl-1">Ambil data internet ke HP ini (Timpa
                            Data HP).</p>
                    </div>
                </div>

                <div class="pt-4 border-t border-gray-100">
                    <button @click="clearLogs()" class="w-full text-red-500 text-xs hover:text-red-700 font-bold">
                        <i class="fa-solid fa-trash mr-1"></i> Hapus Riwayat Transaksi
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script>
        function app() {
            return {
                activeTab: 'laporan', // Default to Laporan to see widgets
                items: JSON.parse(localStorage.getItem('warung_items') || '[]'),
                logs: JSON.parse(localStorage.getItem('warung_logs') || '[]'),
                debts: JSON.parse(localStorage.getItem('warung_debts') || '[]'), // NEW
                googleScriptUrl: localStorage.getItem('warung_gscript_url') || 'https://script.google.com/macros/s/AKfycbyqBhBZsd9tzNZh34bCDnc_XsvjhO_sS9oYQUNK8R7Zo4Tg5s9lxm2R6J5A-YKw3R8e/exec',
                searchQuery: '',
                dateFilter: new Date().toISOString().slice(0, 7), // Default: YYYY-MM

                // Modal States
                isModalOpen: false,
                isStockModalOpen: false, // NEW: Added missing state
                isSellModalOpen: false,
                isSettingsModalOpen: false,
                isReceiptModalOpen: false,
                receiptData: { itemName: '', qty: 0, price: 0, timestamp: '' },
                editMode: false,

                // Scanner
                isScannerOpen: false,
                scanner: null,
                scanMode: 'input', // 'input' (register) or 'kiosk' (sell)
                scanTargetItem: null, // for kiosk mode binding

                // Forms
                tempItem: { id: '', name: '', buyPrice: '', sellPrice: '', stock: '', barcode: '' },
                stockForm: { itemId: null, itemName: '', currentStock: 0, qty: 1, buyPrice: 0, sellPrice: 0 },
                sellForm: { itemId: null, itemName: '', price: 0, buyPrice: 0, qty: 1, maxStock: 0, isDebt: false, customerName: '' }, // Updated for Debt

                get currentDate() {
                    return new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                },

                get filteredItems() {
                    const q = this.searchQuery.toLowerCase();
                    return this.items.filter(i => i.name.toLowerCase().includes(q));
                },

                get salesLogs() {
                    // Filter logs for sales (type 'out')
                    return this.logs.filter(l => l.type === 'out');
                },

                get filteredRevenue() {
                    return this.logs
                        .filter(l => l.type === 'out' && l.timestamp.startsWith(this.dateFilter))
                        .reduce((sum, l) => sum + (l.qty * l.price), 0);
                },

                get filteredProfit() {
                    return this.logs
                        .filter(l => l.type === 'out' && l.timestamp.startsWith(this.dateFilter))
                        .reduce((sum, l) => sum + (l.qty * (l.price - l.buyPrice)), 0);
                },

                get filteredExpense() {
                    return this.logs
                        .filter(l => l.type === 'in' && l.timestamp.startsWith(this.dateFilter))
                        .reduce((sum, l) => sum + (l.qty * l.buyPrice), 0);
                },

                get totalAsset() {
                    return this.items.reduce((sum, item) => sum + (item.buyPrice * item.stock), 0);
                },

                get todayRevenue() {
                    const today = new Date().toISOString().split('T')[0];
                    return this.logs
                        .filter(l => l.type === 'out' && l.timestamp.startsWith(today))
                        .reduce((sum, l) => sum + (l.qty * l.price), 0);
                },

                get todayProfit() {
                    const today = new Date().toISOString().split('T')[0];
                    return this.logs
                        .filter(l => l.type === 'out' && l.timestamp.startsWith(today))
                        .reduce((sum, l) => sum + (l.qty * (l.price - l.buyPrice)), 0);
                },

                get bestSellers() {
                    const salesMap = {};
                    this.logs
                        .filter(l => l.type === 'out')
                        .forEach(l => {
                            if (!salesMap[l.itemId]) salesMap[l.itemId] = { name: l.itemName, qty: 0 };
                            salesMap[l.itemId].qty += l.qty;
                        });

                    return Object.values(salesMap)
                        .sort((a, b) => b.qty - a.qty);
                },

                get worstSellers() {
                    // 1. Calculate sales per item
                    const salesMap = {};
                    this.logs
                        .filter(l => l.type === 'out')
                        .forEach(l => {
                            if (!salesMap[l.itemId]) salesMap[l.itemId] = 0;
                            salesMap[l.itemId] += l.qty;
                        });

                    // 2. Map all items to include those with 0 sales
                    return this.items
                        .map(item => ({
                            name: item.name,
                            stock: item.stock,
                            sales: salesMap[item.id] || 0
                        }))
                        // 3. Filter: Only show active items (stock > 0) to highlight "Dead Money"
                        .filter(i => i.stock > 0)
                        .sort((a, b) => a.sales - b.sales) // Sort Ascending (Lowest Sales First)
                        .slice(0, 3);
                },

                // UTILS
                formatRupiah(value) {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(value);
                },
                formatTime(iso) {
                    return new Date(iso).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                },
                formatDateShort(iso) {
                    return new Date(iso).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                },

                // ITEM CRUD
                openModal(mode, item = null) {
                    this.isModalOpen = true;
                    if (mode === 'edit' && item) {
                        this.editMode = true;
                        this.tempItem = { ...item };
                    } else {
                        this.editMode = false;
                        this.tempItem = { id: null, name: '', buyPrice: '', sellPrice: '', stock: '', barcode: '' };
                    }
                },
                closeModal() { this.isModalOpen = false; },

                // STOCK FLOW (Kulakan)
                openStockModal(item) {
                    this.stockForm = {
                        itemId: item.id,
                        itemName: item.name,
                        currentStock: item.stock,
                        qty: 1,
                        buyPrice: item.buyPrice, // Pre-fill with current AVCO price
                        sellPrice: item.sellPrice
                    };
                    this.isStockModalOpen = true;
                },

                saveItem() {
                    if (!this.tempItem.name) return alert("Nama wajib diisi!");
                    const item = {
                        id: this.tempItem.id || Date.now(),
                        name: this.tempItem.name,
                        buyPrice: Number(this.tempItem.buyPrice),
                        sellPrice: Number(this.tempItem.sellPrice),
                        stock: Number(this.tempItem.stock),
                        barcode: this.tempItem.barcode || ''
                    };

                    if (this.editMode) {
                        const index = this.items.findIndex(i => i.id === item.id);
                        if (index !== -1) {
                            this.items.splice(index, 1, item);
                        }
                    } else {
                        this.items.push(item);
                    }
                    this.saveToStorage();
                    this.closeModal();
                },

                deleteItem() {
                    if (confirm("Hapus barang ini?")) {
                        this.items = this.items.filter(i => i.id !== this.tempItem.id);
                        this.saveToStorage();
                        this.closeModal();
                    }
                },

                editItem(item) { this.openModal('edit', item); },

                // SALES FLOW
                openSellModal(item) {
                    this.sellForm = {
                        itemId: item.id,
                        itemName: item.name,
                        price: item.sellPrice,
                        buyPrice: item.buyPrice,
                        qty: 1,
                        maxStock: item.stock,
                        isDebt: false,
                        customerName: ''
                    };
                    this.isSellModalOpen = true;
                },
                closeSellModal() { this.isSellModalOpen = false; },

                confirmSale() {
                    if (this.sellForm.qty > this.sellForm.maxStock) return alert("Stok tidak cukup!");

                    // DEBT LOGIC
                    if (this.sellForm.isDebt) {
                        if (!this.sellForm.customerName) return alert("Nama Peminjam wajib diisi!");

                        // Add to Debts
                        this.debts.push({
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            customerName: this.sellForm.customerName,
                            itemId: this.sellForm.itemId, // Store itemId for potential future use
                            itemName: this.sellForm.itemName,
                            qty: this.sellForm.qty,
                            price: this.sellForm.price,
                            buyPrice: this.sellForm.buyPrice, // Store buyPrice for profit calculation when paid
                            total: this.sellForm.qty * this.sellForm.price,
                            status: 'unpaid'
                        });

                        // Reduce Stock ONLY (No Revenue Log yet)
                        const idx = this.items.findIndex(i => i.id === this.sellForm.itemId);
                        if (idx !== -1) {
                            this.items[idx].stock -= this.sellForm.qty;
                        }

                        alert("Hutang tercatat! Stok berkurang, tapi belum masuk omzet.");

                    } else {
                        // NORMAL SALE
                        const log = {
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            type: 'out',
                            itemId: this.sellForm.itemId,
                            itemName: this.sellForm.itemName,
                            qty: parseInt(this.sellForm.qty),
                            price: parseInt(this.sellForm.price),
                            buyPrice: parseInt(this.sellForm.buyPrice)
                        };

                        this.logs.unshift(log); // Use unshift to add to the beginning
                        const idx = this.items.findIndex(i => i.id === this.sellForm.itemId);
                        if (idx !== -1) {
                            this.items[idx].stock -= log.qty;
                        }

                        this.playSound('coin'); // Sound only for cash
                    }

                    this.saveToStorage();
                    this.closeSellModal();
                },
                saveStock() {
                    const { itemId, qty, buyPrice, sellPrice } = this.stockForm;
                    const itemIdx = this.items.findIndex(i => i.id === itemId);
                    if (itemIdx === -1) return;

                    const incomingQty = Number(qty);
                    const incomingBuyPrice = Number(buyPrice); // Harga kulak BATCH INI
                    const newSellPrice = Number(sellPrice);

                    // 1. Calculate Weighted Average Cost (Metode Rata-rata)
                    // Rumus: (Total Nilai Lama + Total Nilai Baru) / Total Stok Baru
                    const currentStock = Math.max(0, this.items[itemIdx].stock); // Abaikan minus utk perhitungan aset
                    const currentBuyPrice = this.items[itemIdx].buyPrice;

                    const totalValueOld = currentStock * currentBuyPrice;
                    const totalValueNew = incomingQty * incomingBuyPrice;
                    const totalQty = currentStock + incomingQty;

                    let weightedAvgPrice = incomingBuyPrice; // Default jika stok awal 0
                    if (totalQty > 0) {
                        weightedAvgPrice = (totalValueOld + totalValueNew) / totalQty;
                    }

                    // 2. Update Master Data
                    this.items[itemIdx].stock += incomingQty;
                    this.items[itemIdx].buyPrice = Math.round(weightedAvgPrice); // Simpan rata-rata sebagai harga modal baru
                    this.items[itemIdx].sellPrice = newSellPrice;

                    // 3. Add Log (IN)
                    // Di log, kita catat harga REAL batch ini (bukan rata-rata) agar history belanja akurat
                    const log = {
                        id: Date.now(),
                        type: 'in', // IN
                        itemId,
                        itemName: this.items[itemIdx].name,
                        qty: incomingQty,
                        price: incomingBuyPrice, // Catat harga beli batch ini (untuk laporan pengeluaran)
                        buyPrice: incomingBuyPrice, // Sama, untuk konsistensi data
                        timestamp: new Date().toISOString()
                    };
                    this.logs.unshift(log);

                    this.saveToStorage();
                    this.isStockModalOpen = false;
                    alert(`Stok ditambahkan!\nHarga Modal (Rata-rata) sekarang: ${this.formatRupiah(this.items[itemIdx].buyPrice)}`);
                },

                // AUDIO SYSTEM
                initAudio() {
                    // Coin Sound (Short "Ka-Ching")
                    this.audioCoin = new Audio("https://www.soundjay.com/misc/sounds/magic-chime-01.mp3");

                    // Printer Sound (Short "Dot Matrix / Fax")
                    this.audioPrint = new Audio("https://www.soundjay.com/mechanical/sounds/mechanical-clonk-1.mp3");

                    // Preload
                    this.audioCoin.load();
                    this.audioPrint.load();
                },

                playSound(type) {
                    if (type === 'coin') {
                        this.audioCoin.currentTime = 0;
                        this.audioCoin.play().catch(e => console.log("Audio play failed:", e));
                    } else if (type === 'print') {
                        this.audioPrint.currentTime = 0;
                        this.audioPrint.play().catch(e => console.log("Audio play failed:", e));
                    }
                },

                // NEW FEATURES
                openReceipt(log) {
                    this.receiptData = { ...log };
                    this.isReceiptModalOpen = true;
                },

                downloadReceipt() {
                    this.playSound('print');
                    const el = document.getElementById('receipt-preview');
                    html2canvas(el, { scale: 2 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Struk_WarungSyifa_${this.receiptData.id}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    });
                },

                emailReceipt() {
                    const log = this.receiptData;
                    const subject = `Struk Belanja Warung Syifa - ${log.itemName}`;
                    const body = `Halo,%0A%0ABerikut detail pembelian anda di Warung Syifa:%0A%0AItem: ${log.itemName}%0AJumlah: ${log.qty}%0AHarga Satuan: ${this.formatRupiah(log.price)}%0ATotal: ${this.formatRupiah(log.qty * log.price)}%0AWaktu: ${this.formatDateShort(log.timestamp)} ${this.formatTime(log.timestamp)}%0A%0ATerima kasih!`;
                    window.open(`mailto:?subject=${subject}&body=${body}`);
                },

                sendWhatsApp(log) {
                    const text = `*WARUNG SYIFA*%0A${this.currentDate}%0A%0AItem: ${log.itemName}%0AJumlah: ${log.qty}%0ATotal: ${this.formatRupiah(log.qty * log.price)}%0A%0ATerima kasih sudah berbelanja! ðŸ™`;
                    window.open(`https://wa.me/?text=${text}`, '_blank');
                },

                downloadBackup() {
                    const data = {
                        items: this.items,
                        logs: this.logs,
                        debts: this.debts, // Include debts in backup
                        backupDate: new Date().toISOString()
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `WarungSyifa_Backup_${new Date().toISOString().slice(0, 10)}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                restoreBackup(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.items && data.logs) { // Check for debts too
                                if (confirm(`Restore data dari tanggal ${data.backupDate || 'Unknown'}? Data sekarang akan ditimpa.`)) {
                                    this.items = data.items;
                                    this.logs = data.logs;
                                    this.debts = data.debts || []; // Restore debts, default to empty array if not present
                                    this.saveToStorage();
                                    alert("Berhasil restore data!");
                                    this.isSettingsModalOpen = false;
                                }
                            } else {
                                alert("Format file salah!");
                            }
                        } catch (err) {
                            alert("Gagal membaca file!");
                        }
                    };
                    reader.readAsText(file);
                },

                clearLogs() {
                    if (confirm("Hapus semua riwayat transaksi? Data tidak bisa dikembalikan.")) {
                        this.logs = [];
                        this.saveToStorage();
                        this.isSettingsModalOpen = false;
                    }
                },

                deleteLog(log) {
                    if (!confirm(`Hapus transaksi ini?\n${log.itemName} (${log.qty})`)) return;

                    // 1. Restore Stock if it was a Sale (OUT)
                    if (log.type === 'out') {
                        const itemIdx = this.items.findIndex(i => i.id === log.itemId);
                        if (itemIdx !== -1) {
                            this.items[itemIdx].stock += log.qty; // Return items to stock
                        }
                    }
                    // Note: For 'in' logs, we maintain the stock as is to avoid confusion, 
                    // or user can manually adjust stock. But usually Undo is for sales.

                    // 2. Remove log
                    this.logs = this.logs.filter(l => l.id !== log.id);
                    this.saveToStorage();
                    alert("Transaksi dihapus & stok dikembalikan!");
                },

                async syncToGoogle() {
                    if (!this.googleScriptUrl) return alert("Mohon isi URL Google Apps Script di pengaturan!");

                    const btn = document.activeElement;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
                    btn.disabled = true;

                    try {
                        const payload = {
                            items: this.items,
                            logs: this.logs,
                            debts: this.debts, // Include debts in sync
                            timestamp: new Date().toISOString()
                        };

                        // Use 'no-cors' mode if simply sending data, but usually we want response. 
                        // Google Apps Script requires redirect handling which fetch handles automatically usually.
                        // However, CORS is a common issue. We will use a workaround or standard POST.
                        // Ideally, user sets Web App to "Anyone".

                        await fetch(this.googleScriptUrl, {
                            method: 'POST',
                            mode: 'no-cors', // Important for simple GAS triggers without CORS headaches
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        alert("Data terkirim ke Google Sheets! (Cek Spreadsheet anda)");
                        localStorage.setItem('warung_gscript_url', this.googleScriptUrl);
                    } catch (err) {
                        alert("Gagal sinkronisasi: " + err.message);
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                },

                async pullFromGoogle() {
                    if (!this.googleScriptUrl) return alert("Mohon isi URL Google Apps Script!");

                    if (!confirm("PERINGATAN: Data di HP ini akan DITIMPA dengan data dari Cloud (Google Sheet).\n\nPastikan data di Cloud sudah yang paling baru.\nLanjutkan?")) return;

                    const btn = document.activeElement;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
                    btn.disabled = true;

                    try {
                        const response = await fetch(this.googleScriptUrl);
                        if (!response.ok) throw new Error("Gagal mengambil data (Network Error)");

                        const data = await response.json();

                        if (data.error) throw new Error(data.error);

                        if (data.items && data.logs) {
                            this.items = data.items;
                            this.logs = data.logs;
                            this.debts = data.debts || []; // Restore debts, default to empty array if not present
                            this.saveToStorage();
                            alert("Berhasil mengambil data dari Cloud!");
                            this.isSettingsModalOpen = false;
                        } else {
                            throw new Error("Format data cloud tidak valid.");
                        }

                    } catch (err) {
                        alert("Gagal ambil data: " + err.message + "\n\nPastikan Script sudah di-Deploy ulang dengan akses 'Anyone'.");
                    } finally {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                },

                // SCANNER SYSTEM
                startScanner(mode) {
                    this.scanMode = mode;
                    this.isScannerOpen = true;

                    this.$nextTick(() => {
                        this.scanner = new Html5Qrcode("reader");
                        const config = { fps: 10, qrbox: { width: 250, height: 250 } };

                        this.scanner.start({ facingMode: "environment" }, config, (decodedText) => {
                            this.onScanSuccess(decodedText);
                        }, (errorMessage) => {
                            // ignore errors (scanning...)
                        }).catch(err => {
                            alert("Kamera tidak dapat diakses: " + err);
                            this.isScannerOpen = false;
                        });
                    });
                },

                stopScanner() {
                    if (this.scanner) {
                        this.scanner.stop().then(() => {
                            this.scanner.clear();
                            this.isScannerOpen = false;
                        });
                    } else {
                        this.isScannerOpen = false;
                    }
                },

                onScanSuccess(code) {
                    this.playSound('coin'); // Beep logic

                    if (this.scanMode === 'input') {
                        // Register Mode
                        this.tempItem.barcode = code;
                        this.stopScanner();
                        alert(`Barcode Terdeteksi: ${code}`);
                    } else {
                        // Kiosk Mode (Sell)
                        const foundItem = this.items.find(i => i.barcode === code);
                        if (foundItem) {
                            this.stopScanner();
                            this.openSellModal(foundItem);
                        } else {
                            alert(`Barang tidak ditemukan untuk barcode: ${code}\nSilakan daftarkan dulu di menu stok.`);
                            // Don't stop scanner, let them try again
                        }
                    }
                },

                saveToStorage() {
                    localStorage.setItem('warung_items', JSON.stringify(this.items));
                    localStorage.setItem('warung_logs', JSON.stringify(this.logs));
                    localStorage.setItem('warung_debts', JSON.stringify(this.debts));
                    localStorage.setItem('warung_gscript_url', this.googleScriptUrl);
                },

                // DEBT METHODS
                payDebt(debtId) {
                    const debt = this.debts.find(d => d.id === debtId);
                    if (!debt) return;
                    if (!confirm(`Lunasi hutang ${debt.customerName} sebesar ${this.formatRupiah(debt.total)}?`)) return;

                    // 1. Mark as Paid (Remove from debts list or mark status?)
                    // Let's remove from debts and move to LOGS (real revenue)

                    this.logs.unshift({ // Use unshift to add to the beginning
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'out',
                        itemId: debt.itemId, // Use original itemId
                        itemName: `${debt.itemName} (Lunas: ${debt.customerName})`,
                        qty: debt.qty,
                        price: debt.price,
                        buyPrice: debt.buyPrice // Use stored buyPrice for accurate profit
                    });

                    // Actually, I should update `sellForm.buyPrice` into `debts` in the previous chunk.
                    // For now, I will remove the debt from the array.
                    this.debts = this.debts.filter(d => d.id !== debtId);

                    this.playSound('coin');
                    this.saveToStorage();
                    alert("Hutang Lunas & Masuk Laporan Penjualan!");
                }
            }
        }
    </script>
</body>

</html>